<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">
  <title>
    <%= __('BMSTU_STUDENT_PORTAL')%>
  </title>
  <!-- Bootstrap core CSS-->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
    crossorigin="anonymous">
  <!-- Custom fonts for this template-->
  <link href="/vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
  <!-- Page level plugin CSS-->
  <link href="/vendor/datatables/dataTables.bootstrap4.css" rel="stylesheet">
  <!-- Custom styles for this template-->
  <link href="/css/sb-admin.css" rel="stylesheet">
</head>

<body class="fixed-nav sticky-footer bg-dark" id="page-top">
  <!-- Navigation-->
  <% include navbar %>
    <div class="content-wrapper">
      <div class="container-fluid">
        <!-- Breadcrumbs-->
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
            <a href="#">Dashboard</a>
          </li>
          <li class="breadcrumb-item active">My Dashboard</li>
        </ol>
        <!-- Icon Cards-->
        <div class="row">
          <div class="col-xl-3 col-sm-6 mb-3">
            <div class="card text-white bg-primary o-hidden h-100">
              <div class="card-body">
                <div class="card-body-icon">
                  <i class="fa fa-fw fa-comments"></i>
                </div>
                <div class="mr-5">0
                  <%=__('NEW_MSG')%>!</div>
              </div>
              <a class="card-footer text-white clearfix small z-1" href="#">
                <span class="float-left">
                  <%=__('VIEW_DETAILS')%>
                </span>
                <span class="float-right">
                  <i class="fa fa-angle-right"></i>
                </span>
              </a>
            </div>
          </div>
          <div class="col-xl-3 col-sm-6 mb-3">
            <div class="card text-white bg-warning o-hidden h-100">
              <div class="card-body">
                <div class="card-body-icon">
                  <i class="fa fa-fw fa-user-circle"></i>
                </div>
                <div class="mr-5">0
                  <%=__('NEW_USERS')%>!</div>
              </div>
              <a class="card-footer text-white clearfix small z-1" href="#">
                <span class="float-left" id="viewUsers">
                  <%=__('VIEW_DETAILS')%>
                </span>
                <span class="float-right">
                  <i class="fa fa-angle-right"></i>
                </span>
              </a>
            </div>
          </div>
          <div class="col-xl-3 col-sm-6 mb-3">
            <div class="card text-white bg-danger  o-hidden h-100">
              <div class="card-body">
                <div class="card-body-icon">
                  <i class="fa fa-fw fa-shopping-cart"></i>
                </div>
                <div class="mr-5">
                  <span id="report_num">0</span>
                  <%=__('NEW_REPORTS')%>!</div>
              </div>
              <a class="card-footer text-white clearfix small z-1" href="#">
                <span class="float-left" id="viewReports">
                  <%=__('VIEW_DETAILS')%>
                </span>
                <span class="float-right">
                  <i class="fa fa-angle-right"></i>
                </span>
              </a>
            </div>
          </div>
          <div class="col-xl-3 col-sm-6 mb-3">
            <div class="card text-white bg-success o-hidden h-100">
              <div class="card-body">
                <div class="card-body-icon">
                  <i class="fa fa-fw fa-support"></i>
                </div>
                <div class="mr-5">0
                  <%=__('NEW_NEWS')%>!</div>
              </div>
              <a class="card-footer text-white clearfix small z-1" href="#">
                <span class="float-left">
                  <%=__('VIEW_DETAILS')%>
                </span>
                <span class="float-right">
                  <i class="fa fa-angle-right"></i>
                </span>
              </a>
            </div>
          </div>
        </div>
        <div class="row mt-3">
          <div class="mb-3 col-md-6">
            <div class="card-header">
              Users
              <div class="mr-2 float-right"> <a href="/filter/<%=lang%>">More result</a></div>
            </div>
            <div>
              <table class="table table-hover table-bordered" id="tableUser">
                <thead>
                  <tr>
                    <th scope="col">Fullname</th>
                    <th scope="col">Role</th>
                    <th scope="col">Faculty</th>
                  </tr>
                </thead>
                <tbody>

                </tbody>
              </table>
            </div>
          </div>
          <div class="mb-3 col-md-6">
            <div class="card-header">
             Reports
              <div class="mr-2 float-right"> <a href="/report/<%=lang%>">More result</a></div>
            </div>
            <div>
              <table class="table table-hover table-bordered" id="tableReport">
                <thead>
                  <tr>
                    <th scope="col">User</th>
                    <th scope="col">Description</th>
                    <th scope="col">When</th>
                  </tr>
                </thead>
                <tbody>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="row mt-3">
          <div class="mb-3 col-md-7">
            <div class="card-header">
             News
              <div class="mr-2 float-right"> <a href="/news">More result</a></div>
            </div>
            <div>
              <table class="table table-hover table-responsive" id="tableNews">
                <thead>
                  <!-- <tr>
                    <th scope="col">Fullname</th>
                    <th scope="col">Role</th>
                    <th scope="col">Faculty</th>
                  </tr> -->
                </thead>
                <tbody>
                </tbody>
              </table>
            </div>
          </div>
          <div class="mb-3 col-md-5">
            <div class="card-header">
              Rating
              <div class="mr-2 float-right"> <a href="#">More result</a></div>
            </div>
            <div>
              <table class="table table-hover" id="tableReview">
                <thead>
                  <!-- <tr>
                    <th scope="col">Department</th>
                    <th scope="col">Description</th>
                  </tr> -->
                </thead>
                <tbody>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <footer class="sticky-footer">
        <!-- <div class="container">
          <div class="text-center">
            <small>Copyright Â© Your Website 2018</small>
          </div>
        </div> -->
      </footer>
      <!-- Scroll to Top Button-->
      <a class="scroll-to-top rounded" href="#page-top">
        <i class="fa fa-angle-up"></i>
      </a>
    
      <script src="/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
      <script src="/vendor/jquery-easing/jquery.easing.min.js"></script>
      <script src="/js/sb-admin.min.js"></script>
      <script>
        var lang = '<%=lang%>'
        var user_list = []
        var users = []
        var r = []

        $(() => {
          get_users()
          get_report()
          get_news()
          get_review()
        })

        
        function join_array(array, key, punc) {
          var a = []
          $.each(array, (i, val) => {
            a.push(val[key])
          })
          return a.join(punc)
        }
        function get_users(){
          $.get(`/allu/${lang}?l=5`, (data) => {
            console.log(data)
            if (data.statusCode == 200) {
              $.each(data.response, (i, user) => {
                if(user.department == undefined || user.department.code==undefined) code = '-'
                else code = user.department.code
                $("#tableUser tbody").append(
                  `<tr>
                    <td scope="row">${user.firstname} ${user.lastname}</td>
                    <td>${user.role.name}</td>
                    <td>${code}</td>
                  </tr>`
                )
              })
            }
          })
        }
        function get_report(){
          $.get('/r/new?limit=5', (data) => {
            console.log(data)

            if (data.statusCode == 200) {
              r = data.response

              $("#report_num").html(r.length)
              var report_list = []
              $.each(r, (i, item) => {
                $("#tableReport tbody").append(
                  `<tr>
                    <td>${item.users.user.fullname}</td>
                    <td>  ${item.description}</td>
                    <td><span class="badge badge-warning">${item.status}</span></td>
                  </tr>`
                )
              })
             }
          })
        
        }
        function get_news(){
          $.get('/api/news?limit=5&fields=title,tags', (r)=>{
            if(r.statusCode == 200){
              $.each(r.response, (i, news) => {
                $("#tableNews tbody").append(
                  `<tr>
                    <td scope="row">${news.title}</td>
                    <td>${news.tags}</td>
                    <td>${Intl.DateTimeFormat('en-US').format(new Date(1000 * news.created_when))}</td>
                  </tr>`
                )
              })
            }
          })
        }
        function get_review(){
          $.get('/api/review/department/report/<%=lang%>', (r)=>{
            console.log(r)
            if(r.statusCode == 200){
              deps = r.response.departments
              $.each(r.response.report, (i, item) => {
                $("#tableReview tbody").append(
                  `<tr>
                    <td scope="row">${deps[item._id].name}</td>
                    <td>${parseFloat(item.stars).toPrecision(2)}  <i class="fa fa-star"></i></td>
                  </tr>`
                )
              })
            }
          })
        }
         </script>
    </div>
</body>

</html>